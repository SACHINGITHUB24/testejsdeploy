<%- include('../partials/header', { title }) %>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow border-0">
                <div class="card-header bg-white">
                    <h3 class="mb-0">
                        <i class="fas fa-edit text-warning me-2"></i>Edit Post
                    </h3>
                    <p class="text-muted mb-0 mt-1">Update your post content</p>
                </div>
                
                <div class="card-body p-4">
                    <% if (error) { %>
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <%= error %>
                        </div>
                    <% } %>

                    <form action="/posts/<%= post._id %>?_method=PUT" method="POST" id="editPostForm">
                        <div class="mb-4">
                            <label for="title" class="form-label fw-semibold">
                                <i class="fas fa-heading me-1"></i>Title
                            </label>
                            <input type="text" 
                                   class="form-control form-control-lg" 
                                   id="title" 
                                   name="title" 
                                   value="<%= post.title %>"
                                   required 
                                   maxlength="100"
                                   placeholder="Enter an engaging title for your post">
                            <div class="form-text">
                                <span id="titleCount"><%= post.title.length %></span>/100 characters
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="content" class="form-label fw-semibold">
                                <i class="fas fa-align-left me-1"></i>Content
                            </label>
                            <textarea class="form-control" 
                                      id="content" 
                                      name="content" 
                                      rows="12" 
                                      required 
                                      maxlength="2000"
                                      placeholder="Write your post content here..."><%= post.content %></textarea>
                            <div class="form-text">
                                <span id="contentCount"><%= post.content.length %></span>/2000 characters
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="tags" class="form-label fw-semibold">
                                <i class="fas fa-tags me-1"></i>Tags
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="tags" 
                                   name="tags" 
                                   value="<%= post.tags ? post.tags.join(', ') : '' %>"
                                   placeholder="javascript, web-development, tutorial (separate with commas)">
                            <div class="form-text">
                                Add relevant tags to help others discover your post. Separate multiple tags with commas.
                            </div>
                        </div>

                        <div class="card bg-light mb-4">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-info-circle text-info me-1"></i>
                                    Post Information
                                </h6>
                                <div class="row text-sm">
                                    <div class="col-md-6">
                                        <p class="mb-1">
                                            <strong>Created:</strong> 
                                            <%= new Date(post.createdAt).toLocaleDateString('en-US', { 
                                                year: 'numeric', 
                                                month: 'long', 
                                                day: 'numeric',
                                                hour: '2-digit',
                                                minute: '2-digit'
                                            }) %>
                                        </p>
                                        <p class="mb-1">
                                            <strong>Views:</strong> <%= post.views %>
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1">
                                            <strong>Likes:</strong> <%= post.likes ? post.likes.length : 0 %>
                                        </p>
                                        <p class="mb-1">
                                            <strong>Status:</strong> 
                                            <span class="badge bg-success text-capitalize"><%= post.status %></span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <a href="/posts/<%= post._id %>" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Cancel
                            </a>
                            <div>
                                <button type="button" class="btn btn-outline-primary me-2" onclick="previewPost()">
                                    <i class="fas fa-eye me-1"></i>Preview Changes
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-1"></i>Update Post
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const titleInput = document.getElementById('title');
    const contentTextarea = document.getElementById('content');
    const titleCount = document.getElementById('titleCount');
    const contentCount = document.getElementById('contentCount');

    // Character counting
    titleInput.addEventListener('input', function() {
        titleCount.textContent = this.value.length;
    });

    contentTextarea.addEventListener('input', function() {
        contentCount.textContent = this.value.length;
    });

    // Confirm before leaving if changes made
    let originalTitle = titleInput.value;
    let originalContent = contentTextarea.value;
    
    window.addEventListener('beforeunload', function(e) {
        if (titleInput.value !== originalTitle || contentTextarea.value !== originalContent) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // Remove beforeunload on form submit
    document.getElementById('editPostForm').addEventListener('submit', function() {
        window.removeEventListener('beforeunload', arguments.callee);
    });
});

function previewPost() {
    const title = document.getElementById('title').value;
    const content = document.getElementById('content').value;
    
    if (!title || !content) {
        alert('Please enter both title and content to preview');
        return;
    }
    
    const previewWindow = window.open('', '_blank', 'width=600,height=400,scrollbars=yes');
    previewWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Post Preview - ${title}</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                .post-content { 
                    white-space: pre-line; 
                    line-height: 1.8; 
                }
            </style>
        </head>
        <body class="p-4">
            <div class="container">
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-eye me-2"></i>
                    <strong>Preview Mode</strong> - This is how your updated post will look
                </div>
                <h1 class="mb-4">${title}</h1>
                <div class="post-content">${content}</div>
                <hr class="mt-4">
                <button class="btn btn-secondary" onclick="window.close()">Close Preview</button>
            </div>
        </body>
        </html>
    `);
}
</script>

<%- include('../partials/footer') %>
