<%- include('../partials/header', { title }) %>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow border-0">
                <div class="card-body p-5">
                    <!-- Author Info -->
                    <div class="d-flex align-items-center mb-4">
                        <img src="<%= post.author.avatar %>" 
                             alt="<%= post.author.username %>" 
                             class="rounded-circle me-3" 
                             width="60" height="60">
                        <div class="flex-grow-1">
                            <h6 class="mb-1 fw-semibold"><%= post.author.username %></h6>
                            <div class="text-muted small">
                                <i class="fas fa-calendar me-1"></i>
                                Published on <%= new Date(post.createdAt).toLocaleDateString('en-US', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric' 
                                }) %>
                            </div>
                            <% if (post.author.bio) { %>
                                <div class="text-muted small mt-1">
                                    <%= post.author.bio %>
                                </div>
                            <% } %>
                        </div>
                        
                        <!-- Post Actions -->
                        <% if (user && user.id === post.author._id.toString()) { %>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" 
                                        type="button" 
                                        data-bs-toggle="dropdown">
                                    <i class="fas fa-cog"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item" href="/posts/<%= post._id %>/edit">
                                            <i class="fas fa-edit me-2"></i>Edit Post
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <button class="dropdown-item text-danger" 
                                                onclick="deletePost('<%= post._id %>')">
                                            <i class="fas fa-trash me-2"></i>Delete Post
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        <% } %>
                    </div>

                    <!-- Post Title -->
                    <h1 class="mb-4"><%= post.title %></h1>

                    <!-- Post Meta -->
                    <div class="d-flex flex-wrap align-items-center mb-4 text-muted small">
                        <span class="me-4">
                            <i class="fas fa-eye me-1"></i>
                            <%= post.views %> views
                        </span>
                        <span class="me-4">
                            <i class="fas fa-heart me-1"></i>
                            <span id="likeCount"><%= post.likes ? post.likes.length : 0 %></span> likes
                        </span>
                        <% if (post.updatedAt && post.updatedAt.getTime() !== post.createdAt.getTime()) { %>
                            <span>
                                <i class="fas fa-edit me-1"></i>
                                Updated <%= new Date(post.updatedAt).toLocaleDateString() %>
                            </span>
                        <% } %>
                    </div>

                    <!-- Post Content -->
                    <div class="post-content mb-4" style="white-space: pre-line; line-height: 1.8;">
                        <%= post.content %>
                    </div>

                    <!-- Tags -->
                    <% if (post.tags && post.tags.length > 0) { %>
                        <div class="mb-4">
                            <h6 class="mb-2">
                                <i class="fas fa-tags me-1"></i>Tags
                            </h6>
                            <% post.tags.forEach(tag => { %>
                                <a href="/search?q=<%= encodeURIComponent(tag) %>" 
                                   class="badge bg-secondary text-decoration-none me-2 mb-1">
                                    <%= tag %>
                                </a>
                            <% }); %>
                        </div>
                    <% } %>

                    <!-- Engagement Actions -->
                    <div class="border-top pt-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <% if (user) { %>
                                    <button class="btn btn-outline-danger me-2" 
                                            id="likeBtn"
                                            onclick="toggleLike('<%= post._id %>')"
                                            data-liked="<%= user && post.likes && post.likes.some(like => like._id ? like._id.toString() === user.id : like.toString() === user.id) %>">
                                        <i class="fas fa-heart me-1"></i>
                                        <span id="likeBtnText">
                                            <%= user && post.likes && post.likes.some(like => like._id ? like._id.toString() === user.id : like.toString() === user.id) ? 'Unlike' : 'Like' %>
                                        </span>
                                    </button>
                                <% } %>
                                
                                <button class="btn btn-outline-primary me-2" onclick="sharePost()">
                                    <i class="fas fa-share me-1"></i>Share
                                </button>
                            </div>
                            
                            <a href="/posts" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Back to Posts
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Author's Other Posts -->
            <div class="card shadow border-0 mt-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-edit me-2"></i>
                        More from <%= post.author.username %>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center py-3 text-muted">
                        <i class="fas fa-file-alt fa-2x mb-2"></i>
                        <p class="mb-0">No other posts available</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-share me-2"></i>Share this Post
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Post URL</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="postUrl" readonly>
                        <button class="btn btn-outline-secondary" onclick="copyUrl()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                
                <div class="d-flex gap-2">
                    <a href="#" class="btn btn-primary flex-fill" id="twitterShare" target="_blank">
                        <i class="fab fa-twitter me-1"></i>Twitter
                    </a>
                    <a href="#" class="btn btn-primary flex-fill" id="facebookShare" target="_blank">
                        <i class="fab fa-facebook me-1"></i>Facebook
                    </a>
                    <a href="#" class="btn btn-success flex-fill" id="whatsappShare" target="_blank">
                        <i class="fab fa-whatsapp me-1"></i>WhatsApp
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function toggleLike(postId) {
    try {
        const response = await fetch(`/posts/${postId}/like`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            document.getElementById('likeCount').textContent = data.likes;
            const likeBtn = document.getElementById('likeBtn');
            const likeBtnText = document.getElementById('likeBtnText');
            
            if (data.liked) {
                likeBtn.setAttribute('data-liked', 'true');
                likeBtnText.textContent = 'Unlike';
                likeBtn.classList.remove('btn-outline-danger');
                likeBtn.classList.add('btn-danger');
            } else {
                likeBtn.setAttribute('data-liked', 'false');
                likeBtnText.textContent = 'Like';
                likeBtn.classList.remove('btn-danger');
                likeBtn.classList.add('btn-outline-danger');
            }
        }
    } catch (error) {
        console.error('Error toggling like:', error);
        alert('Failed to update like. Please try again.');
    }
}

function sharePost() {
    const url = window.location.href;
    const title = '<%= post.title.replace(/'/g, "\\'") %>';
    
    document.getElementById('postUrl').value = url;
    
    // Update share links
    document.getElementById('twitterShare').href = 
        `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`;
    document.getElementById('facebookShare').href = 
        `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
    document.getElementById('whatsappShare').href = 
        `https://wa.me/?text=${encodeURIComponent(title + ' - ' + url)}`;
    
    new bootstrap.Modal(document.getElementById('shareModal')).show();
}

function copyUrl() {
    const urlInput = document.getElementById('postUrl');
    urlInput.select();
    document.execCommand('copy');
    
    // Show feedback
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i>';
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-success');
    
    setTimeout(() => {
        button.innerHTML = originalHTML;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
    }, 2000);
}

async function deletePost(postId) {
    if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/posts/${postId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('Post deleted successfully!');
            window.location.href = '/posts';
        } else {
            alert('Failed to delete post. Please try again.');
        }
    } catch (error) {
        console.error('Error deleting post:', error);
        alert('An error occurred. Please try again.');
    }
}

// Initialize like button state
document.addEventListener('DOMContentLoaded', function() {
    const likeBtn = document.getElementById('likeBtn');
    if (likeBtn && likeBtn.getAttribute('data-liked') === 'true') {
        likeBtn.classList.remove('btn-outline-danger');
        likeBtn.classList.add('btn-danger');
    }
});
</script>

<%- include('../partials/footer') %>
